---
title: "Canada's Labour Force - Analysis"
author: "Sherry Luo and Tony Wang"
date: "17/12/2019"
output:
  html_document: default
bibliography: citations.bib
---
```{r setup_packages, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r required_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(ggplot2)
theme_classic()
theme_update(panel.spacing = grid::unit(0, "lines"))
library(scales)
library(viridis)
library(broom)
library(plotly)
library(RColorBrewer)
library(forcats)
library(plotly)
library(stringr)
library(gganimate)
library(sunburstR)
library(cansim)
library(knitcitations)
```
# Part I: Job Tenure in Canada

For this project, we conduct an exploratory analysis on job tenure data collected from Statistics Canada from 1976-2018. Though there are many ways to look at employment data, with job security and the so-called "gig economy" as a topic of discussion in recent years @NBERw22667, we wish to start by seeing how the length of employment of full-time workers has changed over time in Canada by gender and age. Job tenure measures the length of time an employee has been employed by their employer. For this analysis, job tenure was categorized into three groups: short-term (less than 1 year of employment), intermediate (1 to 5 years) and long-term (more than 5 years). 

## Back-to-back Pyramid Plot

<video width="800" height="450" controls>
<source src="output_pyramid.mp4" type="video/mp4">
</video>

### Story: 

We start the analysis with an animated pyramid plot to compare changes in job tenure by gender from 1976-2018. It appears that job tenure has increased for both genders, and a higher number of men appear in each of three groups compared to women. Additionally, changes in job tenure also depends on financial state of Canada. Generally, when the economy is stable, the number of short-term jobs increase and transitional stages (moving from short-term to intermediate and intermediate to long-term positions) follow accordingly. However, when a financial crisis strikes such as the recession in 2008-2012, the number of short-term jobs decrease, but the transition stages in both the intermediate and long-term group remain relatively unchanged (i.e. layoffs affect workers with lower seniorty more compared to workers with higher seniority). The pyramid plot is a nice visual but comparing the distributions of men and women is not obvious and difficult to do. But due to the animated component, each year can only be viewed individually not collectively (hence the possibility of being wrong, as we will see).

### Method:

The cansim package allowed us to easily obtain the data from Statistics Canada. For cleaning, we filtered the necessary data and relabel/order the age and job tenure brackets for clarity. To create a symmetric back-to-back plot, the female values were multiplied by negative one. In terms of design, we selected high contrast colors to compare males and females and added direct labelling. However, as mentioned previously, comparing the distribution over time was not easy. Thus it may have been better to overlay the distributions rather than back-to-back as suggested by Dr.Bolker. The resulting plot will be less attractive but will be more informative for comparison. For more control on playback, we saved the plot as a MP4 and if played continuously each frame is played for 2 seconds (fps=2). Finally, for visual purposes we assumed the bin width to be equal for each job tenure bracket. 

## Average Tenure Plots

```{r averagetenurebySex1, message=FALSE, warning=FALSE, include=FALSE}
dta <- get_cansim(1410005101) %>% normalize_cansim_values()

#CleanData 
dta1 <- (dta
         %>% select(REF_DATE,GEO,`Job tenure`,
                    `Type of work`,Sex,`Age group`,VALUE)
         %>% filter(GEO=="Canada",
                    str_starts(`Job tenure`,"Average"),
                    str_starts(`Type of work`,"Full"),
                    str_detect(`Age group`, "to|65"),
                    str_detect(`Age group`,"44",negate = TRUE))
         %>% mutate(`Job tenure`=factor(`Job tenure`),Sex=factor(Sex),
                    REF_DATE=as.numeric(REF_DATE),`Age group`=factor(`Age group`),
                    VALUE=as.numeric(VALUE))
         %>% drop_na())

#Round to years 
dta2 <- data.frame(dta1 
         %>% group_by(REF_DATE,Sex)
         %>% summarise(mean_tenure = round((mean(VALUE))/12,1))
         %>% mutate(Sex = fct_relevel(Sex, c("Males","Both sexes","Females")))
         %>% rename(Year=REF_DATE,AvgTenure=mean_tenure))

#changed all to purple to better specify the half-way point 
plot <- print(dta2 %>% ggplot(aes(x=Year,y=AvgTenure,color=Sex))
              +geom_point()
              +geom_line()
              + labs(y="Average job tenure (Years)",x="Years",title = "Average job tenure in Canada by sex")
              + theme_minimal()
              + theme(title = element_text(size=9,face="bold"),
                      axis.title.x = element_text(size = 10,
                                                  face = "bold",vjust=0.2),
                      axis.title.y = element_text(size=9,
                                                  face="bold"),
                      axis.text.x = element_text(face="bold"),
                      axis.text.y = element_text(face="bold"))
              + scale_color_manual(values = c("#377eb8","#7e03a8","#cc4678")))

```

```{r averagetenurebySex1_plot, echo=FALSE, message=FALSE, warning=FALSE}
ggplotly(plot) 

```

```{r averagetenurebysex2, message=FALSE, warning=FALSE, include=FALSE}
###Problem with this is that age groups are mixed in...seperate this

dta3 <- data.frame(dta1 
         %>% group_by(REF_DATE,Sex,`Age group`)
         %>% summarise(mean_tenure = round((mean(VALUE))/12,1))
         %>% rename(Year=REF_DATE,AvgTenure=mean_tenure))



#display age and facet gender 
dta4 <- (dta3
         %>% filter(Sex !="Both sexes")
         %>% mutate(Age.group=fct_relevel(Age.group,
                                            c("65 years and over",
                                              "55 to 64 years",
                                              "25 to 54 years",
                                              "15 to 24 years"))))
#remove points to avoid crowding 
p <- print(dta4 %>% 
             ggplot(aes(x=Year,y=AvgTenure,color=Age.group))
           #+ geom_point()
           + geom_line(size=0.7)
           + labs(y="Average job tenure (Years)",x="Years")
           + theme_minimal()
           + theme(
                   axis.title.x = element_text(size =9,
                                               face = "bold"),
                   axis.title.y = element_text(size=9,
                                               face="bold"),
                   axis.text.x = element_text(face="bold"),
                   axis.text.y = element_text(face="bold"))
           + scale_color_manual(values = rev(c("#f89441","#cc4678","#7e03a8","#0d0887"))))


p1 <- print(p 
            + facet_grid(.~Sex)
            + theme(strip.text.x = element_text(size=9,face="bold"),
                    strip.background = element_rect(fill="white")))

```

```{r averagetenurebysex2_plot, echo=FALSE, message=FALSE, warning=FALSE}
ggplotly(p1, width=850, height=500)

```


```{r averagetenurebysex3, message=FALSE, warning=FALSE, include=FALSE}
dta <- get_cansim(1410005101) %>% normalize_cansim_values()


#CleanData 
dta1 <- (dta
         %>% select(REF_DATE,GEO,`Job tenure`,
                    `Type of work`,Sex,`Age group`,VALUE)
         %>% filter(GEO=="Canada",
                    str_starts(`Job tenure`,"Average"),
                    str_starts(`Type of work`,"Full"),
                    str_detect(`Age group`, "to|65"),
                    str_detect(`Age group`,"44",negate = TRUE))
         %>% mutate(`Job tenure`=factor(`Job tenure`),Sex=factor(Sex),
                    REF_DATE=as.numeric(REF_DATE),`Age group`=factor(`Age group`),
                    VALUE=as.numeric(VALUE))
         %>% drop_na())



###Problem with this is that age groups are mixed in...seperate this

dta3 <- data.frame(dta1 
                   %>% group_by(REF_DATE,Sex,`Age group`)
                   %>% summarise(mean_tenure = round((mean(VALUE))/12,1))
                   %>% rename(Year=REF_DATE,AvgTenure=mean_tenure))



#display age and facet gender 
dta4 <- (dta3
         %>% filter(Sex !="Both sexes")
         %>% mutate(Age.group=fct_relevel(Age.group,
                                          c("65 years and over",
                                            "55 to 64 years",
                                            "25 to 54 years",
                                            "15 to 24 years"))))

dta_size <- (dta1
             %>% filter(Sex!="Both sexes")
             %>% group_by(REF_DATE,Sex,`Age group`)
             %>% summarise(CohortSize = sum(VALUE)))


line_width = rep(c(0.01,0.2,0.5,0.85),86)

data1 <- (data.frame(dta4,dta_size$CohortSize,line_width)
          %>% rename(CohortSize=dta_size.CohortSize))
          #%>% mutate(line_width=factor(line_width)))
View(data1)


#remove points to avoid crowding 
p <- print(data1 %>% 
             ggplot(aes(x=Year,y=AvgTenure,size=line_width))
           + geom_line(aes(color=Age.group))
           + labs(y="Average job tenure (Years)",x="Years")
           + theme_minimal()
           + theme(
             axis.title.x = element_text(size =9,
                                         face = "bold"),
             axis.title.y = element_text(size=9,
                                         face="bold"),
             axis.text.x = element_text(face="bold"),
             axis.text.y = element_text(face="bold"))
           + scale_color_manual(values = rev(c("#f89441","#cc4678","#7e03a8","#0d0887"))))


p1size <- print(p 
            + facet_grid(.~Sex)
            + theme(strip.text.x = element_text(size=9,face="bold"),
                    strip.background = element_rect(fill="white")))

```

```{r averagetenurebysex3_plot, echo=FALSE, message=FALSE, warning=FALSE}
ggplotly(p1size, width=850, height=500)

```

### Story:

We created three plots based on the average job tenure. In the first plot, we examined the average tenure by gender and more detailed trends are presented. We see a huge gap between men and women but with time this gap narrowed around the early 2000s due to more women entering the work force around the early 1990s. There are more men in the workforce as indicated by similarity in trend for “males” and “both sex”. Comparing men and women, the average tenure for women increased steadily over time but decreased for men after 1996. However, this plot may be misleading as it does not consider the various age groups of each gender. To address this problem, it is best to separate the age groups for each gender. In this second plot, the average job tenure by gender and age are examined. For women, we see that for all age groups except 15 to 24 year old age brackets, there is a sight increase in the average job tenure over time. For men aged 65 years or more, job tenure increases until 1996 and substantially decreases afterwards. We also see a similar trend in 55 to 64 year old males, though the decrease is very marginal compared to 65 years and older. This slightly contradicts our observation from before since job tenure actually decreased for men after 1996. One issue that is arises is cohort size for each age group. We tried to indicate cohort size by varying the line width for second plot. We see that majority of the workforce is comprised of workers that are 55 years and older.


### Method: 
The two interactive plots were created with plotly. For both plots, we opted for high contrast colors and used the same color palette for aesthetic consistency while trying to keep the plots accessible to the visually impaired. In the first plot, average tenure for men was represented in blue and dark pink for females. We felt purple would be more visually obvious to represent “the halfway” since average tenure for both sexes lie between males and females. In the second plot, the coloring scheme highlights the ordering of the age categories. To determine the line width in the third plot, we summed the overall cohort size for each age group and gender. For all the years, 65 years and plus had the largest cohort size, followed by 55 to 64, 25 to 54 years old and then 15 to 24 years old had the smallest cohort size. Then for each cohort size, we manually specify a line width. 

Facets were used to allow a side-by-side comparison of trends for each gender and age group. We used a linear axis as the discrepancies between groups were substantial and a log-scale would have been rather deceptive when comparing the differences between groups. Additionally, units were rounded to tenth of the year as years is more comprehensible to the general audience. The interactive elements allowed the data to be explored in better detail without adding excessive cluster to the plots. 
## Sunburst Plot 

```{r sunburst, message=FALSE, warning=FALSE, include=FALSE}

library(tidyverse)
library(cansim)
library(stringr)
library(gganimate)
library(sunburstR)

#Function to round values and add prefix 
f2si_round<-function (number,rounding=F) 
{
  lut <- c(1e-24, 1e-21, 1e-18, 1e-15, 1e-12, 1e-09, 1e-06, 
           0.001, 1, 1000, 1e+06, 1e+09, 1e+12, 1e+15, 1e+18, 1e+21, 
           1e+24)
  pre <- c("y", "z", "a", "f", "p", "n", "u", "m", "", "k", 
           "M", "G", "T", "P", "E", "Z", "Y")
  ix <- findInterval(number, lut)
  if (lut[ix]!=1) {
    if (rounding==T) {
      sistring <- paste(round(number/lut[ix],1), pre[ix])
    }
    else {
      sistring <- paste(number/lut[ix], pre[ix])
    } 
  }
  else {
    sistring <- as.character(number)
  }
  return(sistring)
}



dta <- get_cansim(1410005101) %>% normalize_cansim_values()

#CleanData 
dta1 <- (dta
         %>% select(REF_DATE,GEO,`Job tenure`,
                    `Type of work`,Sex,`Age group`,VALUE)
         %>% filter(GEO=="Canada",str_starts(`Job tenure`,"Total",negate = TRUE),
                    str_starts(`Job tenure`,"Average",negate = TRUE),
                    str_starts(`Type of work`,"Full"),
                    Sex != "Both sexes",
                    str_detect(`Age group`, "to|65"),
                    str_detect(`Age group`,"44",negate = TRUE))
         %>% mutate(`Job tenure`=factor(`Job tenure`),Sex=factor(Sex),
                    REF_DATE=as.integer(REF_DATE),`Age group`=factor(`Age group`),
                    VALUE=as.numeric(VALUE))
         %>% drop_na())


#Reorder the job tenure
dta2 <- (mutate(dta1, `Job tenure` = fct_relevel(dta1$`Job tenure`,
                                                 c("1 to 3 months",
                                                   "4 to 6 months",
                                                   "7 to 12 months",
                                                   "13 to 60 months",
                                                   "61 to 120 months",   
                                                   "121 to 240 months",
                                                  "241 months or more"))))

#Recoding labels for clarity
dta3 <- mutate(dta2, `Job tenure` = (dta2$`Job tenure`  
                                     %>% fct_recode(`Job Tenure: 1 to 3 months`="1 to 3 months",
                                                    `Job Tenure: 4 to 6 months` ="4 to 6 months",
                                                    `Job Tenure: 7 to 12 months`="7 to 12 months",
                                                    `Job Tenure: 1 to 5 years`="13 to 60 months",
                                                    `Job Tenure: 5 to 10 years`="61 to 120 months",
                                                    `Job Tenure: 10 to 20 years`="121 to 240 months",
                                                    `Job Tenure: 20 years plus`= "241 months or more")))

dta31 <- mutate(dta3, `Age group`= (dta3$`Age group` 
                            %>% fct_recode(`Age Group: 15 to 24 years`="15 to 24 years",
                            `Age Group: 25 to 54 years` = "25 to 54 years",
                            `Age Group: 55 to 64 years`="55 to 64 years",
                            `Age Group: 65 years and over`="65 years and over")))


dta4 <- data.frame((dta31 
                    %>% mutate(REF_DATE=factor(REF_DATE))
                    %>% select(`Sex`,`Job tenure`,REF_DATE,`Age group`,VALUE)
                    %>% unite(seq,`Sex`:`Age group`,sep="-")
                    %>% select(seq,VALUE)))



dta5 <- data.frame((dta31
                    %>% mutate(REF_DATE=factor(REF_DATE))
                    %>% select(`Sex`,`Job tenure`,REF_DATE,`Age group`,VALUE)
                    %>% mutate(VALUE1 = f2si_round(VALUE,rounding = TRUE))
                    %>% unite(seq,`Sex`:`Age group`,sep="-")
                    %>% select(seq,VALUE1)))



```

```{r sunburstplot, echo=FALSE, message=FALSE, warning=FALSE}
sunplot1 <- sund2b(dta4,
                  rootLabel = "Sex",
                  colors = htmlwidgets::JS("d3.scaleOrdinal(d3.schemeCategory20b)"),
                  tooltip =  sund2bTooltip(followMouse = TRUE,
                                           html = htmlwidgets::JS("function(nodedata, size, percent) {
  return '<span style=\"font-weight: bold;\">' + nodedata.name + '</span>' + ' ' + size
}
    ")
                  ) 
)

sunplot1
```

### Story:

Finally, we conclude the analysis with a sunburst plot. Initially, cumulatively from 1976-2018, the workforce is 40% female and 60% male. As we move upwards to each ring level, we can isolate and analyze specific combinations of the data. With this ordering, we can explore the age composition for each sex at different job tenure levels for different years. For example, among female workers who have been at their job for 1 to 5 years in 2009, majority are between 25 and 54 years old. This scenario can also be examined for men and we see that in 2009, male workers who have been at their job for 1-5 years are mostly between 25 and 54 years old, mirroring the trend that we saw in female workers. 

### Method: 

Sunburst plot was created with the sunburstR package. As Dr.Bolker has stated, these plots are heavily dependent on the ordering of the variables. To suit our analysis above, we selected the ordering to be  gender, job tenure, specific year then age group. We added a tooltip that allows a user to select a specific wedge of the plot and the breakdown can be seen on the right. We did consider rounding the numeric values in the tooltip, however, customizing it required knowledge of javascript. The d3.js categorical color scheme was used here. 

### Possible Explainations for Observed Trend  
Overall, we see that job tenures are increasing for females, whereas job tenure for males is decreasing.  Several possible reasons for these trends are: 

-Better workplace accommodations for women such as maternity leave, as well as possible social shifts on the role of men in parenting. 
-The unstable yet highly lucrative nature of work in the technology sector, which is heavily male-dominated, may partially explain the trend towards shorter job tenures for males, who may hop from one startup company to another for short periods of time before making enough money to exit the traditional full-time workforce. 
-Globalization may result in highly experienced workers having greater access to lucrative job positions in other countries, which would result in an outflux of workers in older age brackets.
-People from the silent generation may have come to retirement age in large numbers from 1997 onwards



# Part II: Gender Pay Gap Analysis

For the second part of the analysis, we will look at some specific aspects of the workforce in recent years. One topic that frequently comes up when people discuss labour data is the gender pay gap, which can generally be described as a discrepancy between how much men and women get paid for comparable work. Everyone has heard about the 70 cents to the dollar saying, but considering how people's pay differ depending on fields of study, education levels, region, and many other features, it is beneficial to take a precursory glance at these sorts of variations to see how things actually work.

## Geospatial Facet Plot

```{r geospatial, message=FALSE, warning=FALSE, include=FALSE}
library(ggmap)
library(sf)
library(htmlwidgets)
library(rgdal) #This seems to work better for me than sf for reading shape files when they need to be re-projected

##Facet plot for gender breakdown by Industry
## Additional tooltips for Workforce size, male and female median annual wages

####################################################

##Download Original Zip File for Industry by Gender (Reminder only)
##download.file("https://www12.statcan.gc.ca/census-recensement/2016/dp-pd/hlt-fst/edu-sco/Tables/Files/98-402-X2016010-T4-csv-eng.zip", destfile="Utility/statscan.zip")

##Wage Data File by Industry
##Custom extraction from original 6GB census data
wages <- read_csv("Writeup Stuff/wageData.csv")

## Unzip and read CSV for Industry by Gender (Note: Parsing failures are blank rows in the data)
## Many, many columns to rename...
## Drop useless columns and NA rows
source <- read_csv("Writeup Stuff/98-402-X2016010-T4-CANPR-eng.csv") 
source_renamed <- (source %>% rename("GeoName"="Geographic name", 
                                     "AreaTotal"="Total – STEM and BHASE (non-STEM) groupings - Classification of Instructional Programs (CIP) 2016 (2016 counts)",
                                     "Science and science technology"="STEM fields of study - Science and science technology (2016 counts)",
                                     "Engineering and engineering technology"="STEM fields of study - Engineering and engineering technology (2016 counts)",
                                     "Mathematics and computer and information science"="STEM fields of study - Mathematics and computer and information science (2016 counts)",
                                     "Business and administration"="BHASE (non-STEM) fields of study - Business and administration (2016 counts)",
                                     "Arts and humanities"="BHASE (non-STEM) fields of study - Arts and humanities (2016 counts)",
                                     "Social and behavioural sciences"="BHASE (non-STEM) fields of study - Social and behavioural sciences (2016 counts)",
                                     "Legal professions and studies"="BHASE (non-STEM) fields of study - Legal professions and studies (2016 counts)",
                                     "Health care"="BHASE (non-STEM) fields of study - Health care (2016 counts)",
                                     "Education and teaching"="BHASE (non-STEM) fields of study - Education and teaching (2016 counts)",
                                     "Trades, services, natural resources and conservation"="BHASE (non-STEM) fields of study - Trades, services, natural resources and conservation (2016 counts)",
                                     "TotalPercent"="Total – STEM and BHASE (non-STEM) groupings - Classification of Instructional Programs (CIP) 2016 (% distribution 2016)"
)
%>% drop_na()
%>% filter(GeoName!="Canada")
%>% filter(Age=="All ages, 15-plus")
%>% dplyr::select(-c("Geographic code", "Age", "Global non-response rate", "Data quality flag", 19:29))
)

## Join wage data with demographic data
merged <- (source_renamed %>% gather(c(5:14), key="Industry", value="Cohort Size") 
%>% left_join(wages))

##Numbers for both genders
bothsexes <- (merged
              %>% filter(Sex== "Both sexes")
              %>% rename("Median Income (Both Genders)"="Median Income")
              %>% dplyr::select(-c("Sex"))
)

##Numbers for females only
females <- (merged
            %>% filter(Sex== "Female")
            %>% rename("Median Income (Female)"="Median Income",
                       "FemaleGenderCount"="Cohort Size")
            %>% dplyr::select(-c("Sex", "AreaTotal"))
)

##Numbers for males only
males <- (merged
            %>% filter(Sex== "Male")
            %>% rename("Median Income (Male)"="Median Income")
          %>% dplyr::select(-c("Cohort Size", "Sex", "AreaTotal"))
)


##Recombine Tables and Calculate Female Proportions
##Filter out Most Frequent Industries per Jurastiction
femaleprop <- (left_join(bothsexes,females) %>% left_join(males)
               %>% mutate(FemalePercent = round(100*(FemaleGenderCount/`Cohort Size`), digits=0))
)

##Extract most common industry by education level, based on femaleprop table
##Create Five Tables For Different Education Levels
##Within each table, extract top value for each province, then rejoin all at the end
##Not ideal but this level of striation requires some drastic measures to clean

College <- (femaleprop %>% filter(Education=="College, CEGEP or other non-university certificate or diploma") 
            %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
UniCert <- (femaleprop %>% filter(Education=="University certificate, diploma or degree at bachelor level or above")
            %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
Bach <- (femaleprop %>% filter(Education=="Bachelor's degree")
         %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
Master <- (femaleprop %>% filter(Education=="Master's degree")
           %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
PhD <- (femaleprop %>% filter(Education=="Earned doctorate")
        %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))

#Final Cleaned Data Table
dtafin <- (bind_rows(College, UniCert, Bach, Master, PhD, id=NULL))
##Factor Education Column (essentially for facet reordering)
dtafin$Education <- factor(dtafin$Education, levels = c("College, CEGEP or other non-university certificate or diploma",
                                                        "University certificate, diploma or degree at bachelor level or above",
                                                        "Bachelor's degree",
                                                        "Master's degree",
                                                        "Earned doctorate"), ordered = TRUE)             
## If no Income data is available, replace value with "No Data"
dtafin$`Median Income (Female)`[which(dtafin$`Median Income (Female)`==0)] <- "No Data"
dtafin$`Median Income (Male)`[which(dtafin$`Median Income (Male)`==0)] <- "No Data"

####################################################

## Load Shape File, Join Shape File with Data 
## Use digital boundary file for performance
canada_shape <- st_read("Writeup Stuff/lpr_000a16a_e.shp")
joined_dta <- left_join(canada_shape, dtafin, by=c("PRENAME"="GeoName")) %>% dplyr::rename("Jurisdiction"="PRENAME")

##Change strip text names without renaming data
Facet_names <- c(
  `College, CEGEP or other non-university certificate or diploma` = "College and Other",
  `University certificate, diploma or degree at bachelor level or above` = "University Certificate",
  `Bachelor's degree` = "Bachelor's degree",
  `Master's degree` = "Master's degree",
  `Earned doctorate` = "Earned doctorate"
)

#Create ggplot with dummy aesthetics for later use
plot <- (ggplot(joined_dta)
         + geom_sf(aes(common=Jurisdiction, 
                       fill=Industry, label1=`Cohort Size`, 
                       label2=FemalePercent, 
                       label3=`Median Income (Female)`,
                       label4=`Median Income (Male)`,
                       geometry=geometry))
         + scale_fill_viridis(discrete=TRUE, option="plasma")
         + xlab("Longitude")
         + ylab("Latitude")
         + facet_wrap(~Education, labeller = as_labeller(Facet_names))
         + theme_classic()
         + guides(alpha=FALSE)
         + theme(legend.position=c(0.83, 0.25), 
                 panel.spacing = unit(0.5, "lines"),
                 axis.text = element_blank(),
                 axis.ticks=element_blank(),
                 legend.title = element_blank(),
                 axis.title.x = element_blank(),
                 axis.title.y = element_blank(),
                 )
)

##Map with multiple tooltips
##Trick is to use previously established dummy aesthetics to display info in joined table

htmlplot <- (ggplotly(plot, tooltip=c("common", "label1", "label2", "label3", "label4"), width=800, height=450) 
  %>% add_annotations(text="Predominant Field for Workforce Cohort",
                      xref="paper", yref="paper",
                      x=0.7, xanchor="left",
                      y=0.47, yanchor="top",
                      legendtitle=TRUE, showarrow=FALSE)
  %>% layout(autosize=F, legend=list(x=0.7, y=0.025, yanchor="bottom"), hovermode = "closest") 
)
```

```{r geoplot_int, echo=FALSE, message=FALSE, warning=FALSE}
htmlplot
```

### Story:

We begin by looking at the gender pay gap through the creation of an interactive, multi-faceted geospatial plot, coloured by the predominant field for each workfoace cohort. From this plot, we see that:

- At the College-level and below, business is the predominant field of study for all provinces and Yukon, and the trades/natural resources is the most common field in the NorthWest Territories and Nunavut.
- At the University Certificate level, the most populus provinces in Canada (Ontario, Quebec, British Columbia and Alberta) have business as the most common field of study, with the rest of the provinces and territories having Education as the most common field.
- At the Bachelor's degree level, Social sciences become the most common field in Ontario, British Columbia and the Yukon, and Business becomes the most common field of study in New Brunswick, but for all other provinces, the field of study remains the same as the University Certificate level.
- Geographical Industry trends at the Master's degree level largely resemble those at the University Certificate level, with the exception of New Brunswick and Manitoba
- At the Doctorate level, sciences are the single most common field of study in every province and territory; however, it is interesting to note that this is for the physical sciences (i.e. biology, chemistry, and physics), meaning that this does not include mathematics and computer sciences.

Now that we have an idea of what the most common fields of study are in different provinces and territories, we can look at the gender balance within each of these fields as well as any gender pay gaps. They can be briefly summarized as follows:

- Where Business and administration is the predominant field, females generally make up between 40 to 80 percent of that particular cohort, with the proportion of females generally declining as the education level goes up. There appears to be a universal gender pay gap across all provinces that goes anywhere between 7% (minimum value, in Prince Edward Island at the Bachelor's level) to around 24% (as observed in Alberta at the Master's degree level).
- In provinces and territories where Education is the most common field of study, females make up at least 60% of that particular cohort. For people with Master's degrees, Nunavut and Prince Edward Island have slightly greater median pay levels for females than males, though the difference is very small. In other areas where education is the most common field, the median salary of males is greater than that of females, though this difference ranges from slight (Nova Scotia, Master's degree level) to substantial (e.g. Saskatchewan, University certificate level).
- Science disciplines are the predominant field of study at the doctorate level across all genders. In all provinces, females make up between 30 to 45 percent of the Science PhD cohort, and with the exception of Nova Scotia, males have a greater median salary in all provinces than females. The territories have so few Sciences PhDs that with the exception of males in the Northwest Territories, Statistics Canada actually does not provide wage data. No inferences can be made for these regions given the small number of relevant individuals.
- Social sciences are predominant at the Bachelor's degree level for only two provinces and one territory. These cohorts are roughly 60% female and there appears to be a consistent and rather sizable gender pay gap in favour of males across all three of these jurisdictions. 
- The trades, services, natural resources and conservation fields have very low female representation (roughly 30%), and a pay gap of either 10 percent (Nunavut) or 25 percent (Northwest Territories) in favor of males. 

### Method:

To look at gender pay gaps, we combined industry and wage data obtained from the 2016 Census into an interactive, multi-faceted geospatial plot, coloured by the predominant field for each workfoace cohort. The data we used comes from two datasets of the 2016 Census, one of which covered wages of individuals by gender and field of study (Catalogue No. 98-400-X2016280), and one of which tallied the number of employees by various factors such as industry (Catalogue No. 98-402-X2016010-T4), gender, field of study and earned qualifications. The wage data from statistics Canada was extracted from the source data, a 6GB CSV file, using a workstation desktop with the necessary system resources to do so, and all plots were used on the reduced dataset to reduce system resource usage. These datasets were combined and used to create a five facet geospatial plot using the simplified digital boundary files. The use of digital boundary files rather than detailed cartographic files accelerates the rendering process and reduces the final file size, albeit at the cost of some information about the northern territories' islands. For the purposes of this analysis, this appears to be fine.

The viridis "C" or "plasma" color scale was used for brightness and high contrast, not uniformity. Though the levels of the factors are not directional, these colors are still bright enough and distinctive enough such that they are suitable for distinguishing the different fields. It was decided to facet the geospatial data by education levels in order to best see how education levels may be related to the fields and location, and the rest of the information on cohort sizes, female representation, and salaries by field and gender were added into the hover tooltip through the use of several dummy aesthetics.

### Advantages and Disadvantages:

The advantage of the spatial plot is that it allows people to immediately identify the largest educational cohort within each province, and see some useful information about demographics and median pay within that cohort should they desire to. That is, this graphic provides a very brief high-level overview for those who are not interested in aggregated national level data, but want to get an idea of what they may expect when they look at regional-level data. However, we do acknowledge that doing things this way, while being a non-invasive way to present large amounts of data on the most common industries within each province or territory, does have limitations:

- First, this plot only shows relevant information for the largest field of study. The issue here is that if there are two educational cohorts that both make up, for example, around 40 percent of the total population for that province, the smaller of the two will not be shown.
- Secondly, there is currently no built-in mechanism to simultaneously pinpoint multiple entries at once. This makes it tedious to make multiple comparisons.
- Third, there is an argument to be made that province-level data may not be as relevant as the national-level difference between different age groups.
- As a technical point, the hover only really works when you go over the edges of the polygon. We suspect this is an issue with how ggplotly interacts with ggplot in the creation of traces, though we were unfortunately unable to correct this behaviour. 

Overall, it seems that we do need to take a more in-depth look at the situation given what we have seen.

## Facet Dot Plot

```{r facetdot, echo=FALSE, fig.width=12, fig.height=10, message=FALSE, warning=FALSE}
merged <- (read_csv("Writeup Stuff/wageData_national.csv") 
           %>% filter(`Median Income`!= 0))
merged$Education <- factor(merged$Education, levels = c("College, CEGEP or other non-university certificate or diploma",
                                                        "University certificate, diploma or degree at bachelor level or above",
                                                        "Bachelor's degree",
                                                        "Master's degree",
                                                        "Earned doctorate"), ordered = TRUE)    
merged$`Median Income` <- unlist(merged$`Median Income`)

#############################################

Facet_names <- c(
  `College, CEGEP or other non-university certificate or diploma` = "College and Other",
  `University certificate, diploma or degree at bachelor level or above` = "University Certificate",
  `Bachelor's degree` = "Bachelor's degree",
  `Master's degree` = "Master's degree",
  `Earned doctorate` = "Earned doctorate"
)

#Simple Facet Plot for Industry by Age by Education Level (National Level)

(ggplot(merged, aes(x=merged$`Median Income`, y=Industry, color=Sex, group=Sex))
  + geom_point()
  + theme_dark()
+ scale_x_log10(labels= comma)
+ scale_color_manual(values=c("pink", "blue"))
+ facet_grid(Education ~ Age, labeller = labeller(Education = Facet_names))
+ xlab("National Median Income (CAD)")
+ ylab("Field")
)
```

### Story

Given the considerations we noted above, it was decided that a single static plot, with multiple facets for different industries, age groups, and education levels for national-level data, would allow us to somewhat address all of the issues at hand from the initial exploratory plot on regional-level data. Data was sourced again frome the 2016 census, except this time, age information was retained and since we are no longer interested in cohort sizes, it was possible to source all of the information from the 2016 Census, Catalogue No. 98-400-X2016280 (Statistics Canada, 2018). From the facet plot, we see that:

- The gender pay gap seems to be the least prominent for the 15 to 29 year old age cohort. Whele the differences are slightly in favour of Males at the College level, and somewhat in favour of females at the Doctorate level, the difference at other levels of Education for this cohort, while technically in favour of males, is extremely small. 
- For those aged 30 to 59, there is a consistent pay gap in favour of males across virtually every industry and education level up to the Master's degree level. While there are some exceptions where females are paid similarly, the gender pay gap appears fairly persistent across a variaety of circumstances. While there is a pay gap at the doctorate level that generally favours males, the picture is not as clear. 
- At the 60+ age group, we notice that the gender pay gaps are still present, but are far more erratic than those in other age groups. While pay gaps at different educational levels still seem to favour males, these trends are much less consistent across both educational lebels and industries.
- In terms of industries, health care at the University Certificate, Bachelor's degree and Master's degree consistently offers comparable pay to both genders. However, at the College level, there is a persistent pay gap in favour of males at all education levels, while at the doctorate level and adove the 15-29 year age brackets, there is a persistent pay gap in favour of females that enlarges at the 60+ age group. Otherwise, there are few consistent trends with respect to industry.

Overall, based on the national level data, we see that there is a persistent gender pay gap across a variety of settings and industries, but the picture is not very clear cut. It seems that the strongest trend appears to be the appearence of a pay gap for those at the university level after the 15 to 29 year bracket that persists well into the working years, but narrows as workers approach the age of 60. It is entirely possible that the observed trends are the result of some sort of "motherhood penalty", where younger women upon having children get treated differently and "lose out" on pay increases and promotion @budig2001wage, but work experience gained over time may reduce these differences as workers get older. A more detailed analysis will be needed if we are to check the validity of this conjecture.

### Method

For the purposes of this analysis, we are simply interested in whether there is a consistent pay gap or not based on the factors that are most likely to cause pay variations. Given that there are a large range of possible salaries for different fields of study and educational levels, a log scale was chosen for the horizontal axes for income. Faceting was done by placing education levels as parallel rows and age groups vertically, as each facet by itself is read left to right and sailent comparisons are generally not made between education levels for this topic, but rather between different age groups within the same education level. Colors were selected on the basis of common associations for each gender and to maximize contrast on the background, which was darkened and spaced out to help the reader distinguish between separate facets. Gridlines were included by default and kept as they seem to help somewhat in tracking which values belong to which fields. Finally, fields were left in reverse alphabetical order as there is no way to consistently and naturally order this particular factor. This plot has the advantage of simplicity and clarity at the expense of losing regional-level information in favour of national-level information, but as region may not be as important of a predictor in the preliminary stages of exploratory analysis, this trade-off may be worthwhile for the detailed information it provides.


# References

\bibliography{citations}
\bibliographystyle{abbrv}
---
title: "Canada's Labour Market: Past and Present"
author: "Sherry Luo and Tony Wang"
date: "03/12/2019"
output: 
  ioslides_presentation: 
    widescreen: false
    smaller: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(ggplot2)
theme_classic()
theme_update(panel.spacing = grid::unit(0, "lines"))
library(scales)
library(viridis)
library(broom)
library(gganimate)
library(RColorBrewer)
library(plotly)
library(forcats)
library(cansim)

#Geospatial data related packages
library(ggmap)
library(sf)
library(rgdal)
library(stringr)

#Animated and sunburst related packages 
library(av)
library(sunburstR)

```
## Introduction

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

<<<<<<< HEAD
## Job Tenure of Canada
- Based on job tenure data from Statistics Canada, we wish to explore how the length of employment varied among men and women over the period of 1976 to 2018.
-	Job tenure is defined as the length of time a work has been continuously employed by the same employer and is not affected if an employee changes position within the same company
-	For this exploratory analysis, we created two animated plots and one sunburst plot.

## An animated pyramid plot 
 - The animated pyramid plot illustrates the evolution of tenure according to gender from 1976 to 2018. 
 - We categorized the brackets into 3 categories: 
    +	Short term (1 to 12 months) 
    +	Intermediate (1 to 5 years) 
    +	Longer-term (over 5 years)

## An animated pyramid plot
<video width="320" height="240" controls>
  <source src="output_pyramid.mp4" type="video/mp4">
</video>

## Average job tenure in Canada by Sex 

```{r plotlyLine_setup, message=FALSE, warning=FALSE, include=FALSE}

dta <- get_cansim(1410005101) %>% normalize_cansim_values()

#CleanData 
dta1 <- (dta
         %>% select(REF_DATE,GEO,`Job tenure`,
                    `Type of work`,Sex,`Age group`,VALUE)
         %>% filter(GEO=="Canada",
                    str_starts(`Job tenure`,"Average"),
                    str_starts(`Type of work`,"Full"),
                    str_detect(`Age group`, "to|65"),
                    str_detect(`Age group`,"44",negate = TRUE))
         %>% mutate(`Job tenure`=factor(`Job tenure`),Sex=factor(Sex),
                    REF_DATE=as.numeric(REF_DATE),`Age group`=factor(`Age group`),
                    VALUE=as.numeric(VALUE))
         %>% drop_na())

dta2 <- data.frame(dta1 
         %>% group_by(REF_DATE,Sex)
         %>% summarise(mean_tenure = mean(VALUE))
         %>% mutate(Sex = fct_relevel(Sex, c("Males","Both sexes","Females"))))

# 
# (dta2 %>% plot_ly(x = ~REF_DATE,
#                  y = ~mean_tenure,
#                  split = ~Sex,
#                  #frame = ~REF_DATE,
#                  type = "scatter",
#                  mode = "lines+markers"))

plot <- print(dta2 %>% ggplot(aes(x=REF_DATE,y=mean_tenure,color=Sex))
              +geom_point()
              +geom_line()
              + labs(y="Average job tenure",x="Years",title = "Average job tenure in Canada by sex")
              + theme_minimal()
              + theme(title = element_text(size=10,face="bold"),
                      axis.title.x = element_text(size = 10,
                                                  face = "bold",vjust=0.2),
                      axis.title.y = element_text(size=10,
                                                  face="bold"),
                      axis.text.x = element_text(face="bold"),
                      axis.text.y = element_text(face="bold"))
              + scale_color_manual(values = c("#377eb8","forestgreen","#e41a1c")))

```

```{r averagetenurebySex, echo=FALSE}
ggplotly(plot) 

```

## Job Tenure categorized by Age and Gender 

```{r plotlyLine1_setup, message=FALSE, warning=FALSE, include=FALSE}

###Problem with this is that age groups are mixed in...seperate this

dta3 <- data.frame(dta1 
         %>% group_by(REF_DATE,Sex,`Age group`)
         %>% summarise(mean_tenure = mean(VALUE)))

# #not good
# (dta3 %>% plot_ly(x = ~REF_DATE,
#                   y = ~mean_tenure,
#                   split = ~Age.group,
#                   #frame = ~REF_DATE,
#                   type = "scatter",
#                   mode = "lines+markers"))

#display age and facet gender 
dta4 <- (dta3 %>% 
           filter(Sex !="Both sexes"))

p <- print(dta4 %>% 
             ggplot(aes(x=REF_DATE,y=mean_tenure,color=Age.group))
           + geom_point()
           + geom_line()
           + labs(y="Average job tenure",x="Years")
           + theme_minimal()
           + theme(legend.position = "none",
                   axis.title.x = element_text(size = 10,
                                               face = "bold",vjust=0.2),
                   axis.title.y = element_text(size=10,
                                               face="bold"),
                   axis.text.x = element_text(face="bold"),
                   axis.text.y = element_text(face="bold")))


p1 <- print(p 
            + facet_grid(.~Sex)
            + theme(strip.text.x = element_text(size=10,face="bold"),
                    strip.background = element_rect(fill="white")))


```

```{r averageTenure_Age_Gender, echo=FALSE}

ggplotly(p1)

```

## A Sunburst Plot
```{r sunburst_setup, message=FALSE, warning=FALSE, include=FALSE}
dta <- get_cansim(1410005101) #%>% normalize_cansim_values()

#CleanData 
dta1 <- (dta
         %>% select(REF_DATE,GEO,`Job tenure`,
                    `Type of work`,Sex,`Age group`,VALUE)
         %>% filter(GEO=="Canada",str_starts(`Job tenure`,"Total",negate = TRUE),
                    str_starts(`Job tenure`,"Average",negate = TRUE),
                    str_starts(`Type of work`,"Full"),
                    Sex != "Both sexes",
                    str_detect(`Age group`, "to|65"),
                    str_detect(`Age group`,"44",negate = TRUE))
         %>% mutate(`Job tenure`=factor(`Job tenure`),Sex=factor(Sex),
                    REF_DATE=as.integer(REF_DATE),`Age group`=factor(`Age group`),
                    VALUE=as.numeric(VALUE))
         %>% drop_na())


#Reorder the job tenure
dta2 <- (mutate(dta1, `Job tenure` = fct_relevel(dta1$`Job tenure`,
                                                 c("1 to 3 months",
                                                   "4 to 6 months",
                                                   "7 to 12 months",
                                                   "13 to 60 months",
                                                   "61 to 120 months",   
                                                   "121 to 240 months",
                                                  "241 months or more"))))

#Recoding labels for clarity
dta3 <- mutate(dta2, `Job tenure` = (dta2$`Job tenure`  
                                     %>% fct_recode(`Job Tenure: 1 to 3 months`="1 to 3 months",
                                                    `Job Tenure: 4 to 6 months` ="4 to 6 months",
                                                    `Job Tenure: 7 to 12 months`="7 to 12 months",
                                                    `Job Tenure: 1 to 5 years`="13 to 60 months",
                                                    `Job Tenure: 5 to 10 years`="61 to 120 months",
                                                    `Job Tenure: 10 to 20 years`="121 to 240 months",
                                                    `Job Tenure: 20 years plus`= "241 months or more")))

dta31 <- mutate(dta3, `Age group`= (dta3$`Age group` 
                            %>% fct_recode(`Age Group: 15 to 24 years`="15 to 24 years",
                            `Age Group: 25 to 54 years` = "25 to 54 years",
                            `Age Group: 55 to 64 years`="55 to 64 years",
                            `Age Group: 65 years and over`="65 years and over")))


dta4 <- data.frame((dta31 
                    %>% mutate(REF_DATE=factor(REF_DATE))
                    %>% select(`Sex`,`Job tenure`,REF_DATE,`Age group`,VALUE)
                    %>% unite(seq,`Sex`:`Age group`,sep="-")
                    %>% select(seq,VALUE)))
```

```{r sunburstPlot, echo=FALSE}
sunplot1 <- print(sund2b(dta4,
                  rootLabel = "Sex",
                  colors = htmlwidgets::JS("d3.scaleOrdinal(d3.schemeCategory20b)"),
                  tooltip =  sund2bTooltip(followMouse = TRUE,
                                           html = htmlwidgets::JS("
function(nodedata, size, percent) {
  return '<span style=\"font-weight: bold;\">' + nodedata.name + '</span>' + ' ' + size
}
    ")
                  ) 
))

```



## Pay Gaps, Industry, and Geography
* When talking about job data, one thing that frequently comes up is the gender wage gap
* Common saying is that women get paid 70 cents for every dollar men get paid
* Problem is that pay depends on many different factors
* Among people with the same educational level and the same field of study, is there a major gender pay gap for different parts of Canada?

## Pay Gaps, Industry, and Geography
* We combined two subsets of the 2016 Census Data
  + Employment Income by Major Field of Study (98-400-X2016280)
  + Field of Study Groupings for Age Groups, Sex, and educational attainment (98-402-X2016010-T4)
* We then calculated the proportion of females in the workforce using the count data of each cohort
* Cleaned data was used to create a faceted map
* ggplotly was used to make the facet plot interactive
* Tooltips of detailed information were added using "dummy" aesthetics in ggplot

## Pay Gaps, Industry, and Geography

```{r geospatial_setup, message=FALSE, warning=FALSE, include=FALSE}

##Wage Data File by Industry
##Custom extraction from original 6GB census data
wages <- read_csv("Utility/wageData.csv")

## Unzip and read CSV for Industry by Gender (Note: Parsing failures are blank rows in the data)
## Many, many columns to rename...
## Drop useless columns and NA rows
source <- read_csv("Utility/98-402-X2016010-T4-CANPR-eng.csv") 
source_renamed <- (source %>% rename("GeoName"="Geographic name", 
                                     "AreaTotal"="Total – STEM and BHASE (non-STEM) groupings - Classification of Instructional Programs (CIP) 2016 (2016 counts)",
                                     "Science and science technology"="STEM fields of study - Science and science technology (2016 counts)",
                                     "Engineering and engineering technology"="STEM fields of study - Engineering and engineering technology (2016 counts)",
                                     "Mathematics and computer and information science"="STEM fields of study - Mathematics and computer and information science (2016 counts)",
                                     "Business and administration"="BHASE (non-STEM) fields of study - Business and administration (2016 counts)",
                                     "Arts and humanities"="BHASE (non-STEM) fields of study - Arts and humanities (2016 counts)",
                                     "Social and behavioural sciences"="BHASE (non-STEM) fields of study - Social and behavioural sciences (2016 counts)",
                                     "Legal professions and studies"="BHASE (non-STEM) fields of study - Legal professions and studies (2016 counts)",
                                     "Health care"="BHASE (non-STEM) fields of study - Health care (2016 counts)",
                                     "Education and teaching"="BHASE (non-STEM) fields of study - Education and teaching (2016 counts)",
                                     "Trades, services, natural resources and conservation"="BHASE (non-STEM) fields of study - Trades, services, natural resources and conservation (2016 counts)",
                                     "TotalPercent"="Total – STEM and BHASE (non-STEM) groupings - Classification of Instructional Programs (CIP) 2016 (% distribution 2016)"
)
%>% drop_na()
%>% filter(GeoName!="Canada")
%>% filter(Age=="All ages, 15-plus")
%>% dplyr::select(-c("Geographic code", "Age", "Global non-response rate", "Data quality flag", 19:29))
)

## Join wage data with demographic data
merged <- (source_renamed %>% gather(c(5:14), key="Industry", value="Cohort Size") 
%>% left_join(wages))

##Numbers for both genders
bothsexes <- (merged
              %>% filter(Sex== "Both sexes")
              %>% rename("Median Income (Both Genders)"="Median Income")
              %>% dplyr::select(-c("Sex"))
)

##Numbers for females only
females <- (merged
            %>% filter(Sex== "Female")
            %>% rename("Median Income (Female)"="Median Income",
                       "FemaleGenderCount"="Cohort Size")
            %>% dplyr::select(-c("Sex", "AreaTotal"))
)

##Numbers for males only
males <- (merged
            %>% filter(Sex== "Male")
            %>% rename("Median Income (Male)"="Median Income")
          %>% dplyr::select(-c("Cohort Size", "Sex", "AreaTotal"))
)


##Recombine Tables and Calculate Female Proportions
##Filter out Most Frequent Industries per Jurastiction
femaleprop <- (left_join(bothsexes,females) %>% left_join(males)
               %>% mutate(FemalePercent = round(100*(FemaleGenderCount/`Cohort Size`), digits=0))
)

##Extract most common industry by education level, based on femaleprop table
##Create Five Tables For Different Education Levels
##Within each table, extract top value for each province, then rejoin all at the end
##Not ideal but this level of striation requires some drastic measures to clean

College <- (femaleprop %>% filter(Education=="College, CEGEP or other non-university certificate or diploma") 
            %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
UniCert <- (femaleprop %>% filter(Education=="University certificate, diploma or degree at bachelor level or above")
            %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
Bach <- (femaleprop %>% filter(Education=="Bachelor's degree")
         %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
Master <- (femaleprop %>% filter(Education=="Master's degree")
           %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))
PhD <- (femaleprop %>% filter(Education=="Earned doctorate")
        %>% group_by(GeoName) %>% slice(which.max(`Cohort Size`)))

#Final Cleaned Data Table
dtafin <- (bind_rows(College, UniCert, Bach, Master, PhD, id=NULL))
##Factor Education Column (essentially for facet reordering)
dtafin$Education <- factor(dtafin$Education, levels = c("College, CEGEP or other non-university certificate or diploma",
                                                        "University certificate, diploma or degree at bachelor level or above",
                                                        "Bachelor's degree",
                                                        "Master's degree",
                                                        "Earned doctorate"), ordered = TRUE)             
## If no Income data is available, replace value with "No Data"
dtafin$`Median Income (Female)`[which(dtafin$`Median Income (Female)`==0)] <- "No Data"
dtafin$`Median Income (Male)`[which(dtafin$`Median Income (Male)`==0)] <- "No Data"

####################################################

## Load Shape File, Join Shape File with Data 
## Use digital boundary file for performance
canada_shape <- st_read("Shape Files/Digital Boundary/lpr_000a16a_e.shp")
joined_dta <- left_join(canada_shape, dtafin, by=c("PRENAME"="GeoName")) %>% dplyr::rename("Jurisdiction"="PRENAME")

##Change strip text names without renaming data
Facet_names <- c(
  `College, CEGEP or other non-university certificate or diploma` = "College and Other",
  `University certificate, diploma or degree at bachelor level or above` = "University Certificate",
  `Bachelor's degree` = "Bachelor's degree",
  `Master's degree` = "Master's degree",
  `Earned doctorate` = "Earned doctorate"
)

#Create ggplot with dummy aesthetics for later use
plot <- (ggplot(joined_dta)
         + geom_sf(aes(common=Jurisdiction, 
                       fill=Industry, label1=`Cohort Size`, 
                       label2=FemalePercent, 
                       label3=`Median Income (Female)`,
                       label4=`Median Income (Male)`,
                       geometry=geometry))
         + scale_fill_viridis(discrete=TRUE, option="plasma")
         + xlab("Longitude")
         + ylab("Latitude")
         + facet_wrap(~Education, labeller = as_labeller(Facet_names))
         + theme_classic()
         + guides(alpha=FALSE)
         + theme(legend.position=c(0.83, 0.25), 
                 panel.spacing = unit(0.5, "lines"),
                 axis.text = element_blank(),
                 axis.ticks=element_blank(),
                 legend.title = element_blank(),
                 axis.title.x = element_blank(),
                 axis.title.y = element_blank(),
                 )
)

#Create ggplot with dummy aesthetics for later use
plot <- (ggplot(joined_dta)
         + geom_sf(aes(common=Jurisdiction, 
                       fill=Industry, label1=`Cohort Size`, 
                       label2=FemalePercent, 
                       label3=`Median Income (Female)`,
                       label4=`Median Income (Male)`,
                       geometry=geometry))
         + scale_fill_viridis(discrete=TRUE, option="plasma")
         + xlab("Longitude")
         + ylab("Latitude")
         + facet_wrap(~Education, labeller = as_labeller(Facet_names))
         + theme_classic()
         + guides(alpha=FALSE)
         + theme(legend.position=c(0.83, 0.25), 
                 panel.spacing = unit(0.5, "lines"),
                 axis.text = element_blank(),
                 axis.ticks=element_blank(),
                 legend.title = element_blank(),
                 axis.title.x = element_blank(),
                 axis.title.y = element_blank(),
                 )
)
```

```{r geospatial, message=FALSE, warning=FALSE}
(ggplotly(plot, tooltip=c("common", "label1", "label2", "label3", "label4"), width=800, height=450) 
  %>% add_annotations(text="Predominant Field for Workforce Cohort",
                      xref="paper", yref="paper",
                      x=0.7, xanchor="left",
                      y=0.47, yanchor="top",
                      legendtitle=TRUE, showarrow=FALSE)
  %>% layout(autosize=F, legend=list(x=0.7, y=0.025, yanchor="bottom"), hovermode = "closest") 
)
```

## Overall Conclusions
* Canada's workforce:
  + Has changed a lot over time demographically
  +
  + Exhibits a gender pay gap